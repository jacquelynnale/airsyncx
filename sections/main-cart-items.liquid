{{ 'section-main-cart-items.css' | asset_url | stylesheet_tag }}
{{ 'social-proof-cart.js' | asset_url | script_tag }}

{%- comment -%}
  AirSyncX Cart Page - Shopify Compatible Implementation
  
  Key Features & Compatibility:
  âœ… Proper Shopify cart form structure with CSRF token
  âœ… Correct cart update API using variant IDs
  âœ… Section rendering for dynamic updates
  âœ… Proper discount code implementation
  âœ… Cart notes support
  âœ… Error handling and accessibility
  âœ… Hebrew RTL support
  âœ… Mobile responsive design
  âœ… Progress bar for free shipping
  âœ… Trust badges and security indicators
  âœ… Empty cart state
  âœ… Quantity validation and error recovery
  âœ… Live region updates for screen readers
  âœ… Proper checkout button implementation
{%- endcomment -%}

{%- comment -%}
  Dynamic Free Shipping Threshold Based on Currency
{%- endcomment -%}
{%- assign free_shipping_threshold = 19900 -%}
{%- if settings.free_shipping_threshold_ils != blank -%}
  {%- assign free_shipping_threshold = settings.free_shipping_threshold_ils | times: 100 -%}
{%- endif -%}

{%- if current_currency.iso_code == 'USD' -%}
  {%- if settings.free_shipping_threshold_usd != blank -%}
    {%- assign free_shipping_threshold = settings.free_shipping_threshold_usd | times: 100 -%}
  {%- else -%}
    {%- assign free_shipping_threshold = 5600 -%}
  {%- endif -%}
{%- elsif current_currency.iso_code == 'EUR' -%}
  {%- if settings.free_shipping_threshold_eur != blank -%}
    {%- assign free_shipping_threshold = settings.free_shipping_threshold_eur | times: 100 -%}
  {%- else -%}
    {%- assign free_shipping_threshold = 2300 -%}
  {%- endif -%}
{%- elsif current_currency.iso_code == 'GBP' -%}
  {%- if settings.free_shipping_threshold_gbp != blank -%}
    {%- assign free_shipping_threshold = settings.free_shipping_threshold_gbp | times: 100 -%}
  {%- else -%}
    {%- assign free_shipping_threshold = 2000 -%}
  {%- endif -%}
{%- endif -%}

{%- comment -%}
  Shopify Markets - Currency & Language Detection
{%- endcomment -%}
{%- assign current_currency = cart.currency -%}
{%- assign current_language = request.locale.iso_code -%}
{%- assign market = localization.market -%}

{%- comment -%}
  RTL/LTR Support Based on Language
{%- endcomment -%}
{%- assign is_rtl = false -%}
{%- if current_language == 'he' or current_language == 'ar' -%}
  {%- assign is_rtl = true -%}
{%- endif -%}

{%- if section.settings.background_image != blank -%}
  {%- assign cart_background_image = section.settings.background_image | image_url -%}
{%- else -%}
  {%- assign cart_background_image = "https://cdn.shopify.com/s/files/1/0931/3724/0362/files/58D88F7C-5197-4837-81BE-A669F3FE7240.png?v=1752672742" -%}
{%- endif -%}

<div class="airsyncx-cart-wrapper" style="--cart-background-image: url('{{ cart_background_image }}');" {% if is_rtl %}dir="rtl"{% else %}dir="ltr"{% endif %} data-currency="{{ current_currency.iso_code }}" data-language="{{ current_language }}">
  <div class="airsyncx-cart-container">
    <!-- ×”×•×¡×¤×ª ×§×™×©×•×¨ ×œ×¡×¤×¨×™×™×ª Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    
    <h1 class="airsyncx-cart-title">
      {{ 'sections.cart.title' | t }}
    </h1>
    
    <form action="{{ routes.cart_url }}" method="post" id="cart">
      <input type="hidden" name="authenticity_token" value="{{ form.authenticity_token }}">
      <div class="airsyncx-cart-layout">
        <div class="airsyncx-cart-main">
          <div id="main-cart-items">
      <div class="js-contents">
        {%- if cart != empty -%}
                {%- assign main_product = cart.items.first -%}
                
                <div class="airsyncx-product-card">
                  <!-- Image Section First -->
                  <div class="airsyncx-product-image-section">
                    <img
                      src="{{ main_product.image | image_url: width: 200 }}"
                      alt="{{ main_product.title | escape }}"
                      class="airsyncx-product-image"
                      loading="lazy"
                      width="160"
                      height="160"
                    >
                    
                    <a href="{{ main_product.url_to_remove }}" class="airsyncx-remove-button" aria-label="{{ 'sections.cart.remove_title' | t: title: main_product.title }}">
                      Ã—
                    </a>
                  </div>
                  
                  <!-- All Content Below Image -->
                  <div class="airsyncx-product-content">
                    <!-- Product Info Section -->
                    <div class="airsyncx-product-main-info">
                      {%- comment -%} Product Category {%- endcomment -%}
                      <div class="airsyncx-product-category">
                        {{ main_product.product.type | escape }}
                      </div>
                      
                      {%- comment -%} Product Name {%- endcomment -%}
                      <h2 class="airsyncx-product-name">{{ main_product.product.title | escape }}</h2>
                      
                      {%- if main_product.product.has_only_default_variant == false -%}
                        <div class="airsyncx-product-variant">
                          {%- for option in main_product.options_with_values -%}
                            {{ option.name }}: {{ option.value }}{% unless forloop.last %} | {% endunless %}
                          {%- endfor -%}
                        </div>
                      {%- endif -%}

                      {%- comment -%} Stock Warning {%- endcomment -%}
                      {%- if main_product.variant.inventory_management == 'shopify' -%}
                        {%- if main_product.variant.inventory_policy == 'deny' and main_product.variant.inventory_quantity > 0 and main_product.variant.inventory_quantity <= 25 -%}
                        <div class="airsyncx-stock-warning">
                            {{ 'products.product.stock.low_stock_with_quantity' | t: quantity: main_product.variant.inventory_quantity }}
                              </div>
                        {%- elsif main_product.variant.inventory_quantity == 0 and main_product.variant.inventory_policy == 'deny' -%}
                          <div class="airsyncx-stock-warning airsyncx-out-of-stock">
                            {{ 'products.product.stock.out_of_stock' | t }}
                              </div>
                          {%- endif -%}
                          {%- endif -%}
                    </div>

                    <!-- Price Section -->
                    <div class="airsyncx-price-total-section">
                      <div class="airsyncx-unit-price">
                        <span>
                          {%- if main_product.variant.compare_at_price > main_product.variant.price -%}
                            <span class="compare-at-price">{{ main_product.variant.compare_at_price | money }}</span>
                          {%- endif -%}
                          <span class="original-price">{{ 'products.product.price.regular_price' | t }}: {{ main_product.original_price | money }}</span>
                        </span>
                        <span class="best-value-badge">âœ“ {% if request.locale.iso_code == "he" %}××—×™×¨ ××©×ª×œ×{% else %}Best Value{% endif %}</span>
                      </div>
                      
                      {%- if main_product.quantity > 1 -%}
                        {%- assign total_savings = main_product.variant.compare_at_price | minus: main_product.variant.price | times: main_product.quantity -%}
                        {%- if total_savings > 0 -%}
                        <div class="airsyncx-savings">
                            {%- if current_language == 'en' -%}
                              You save {{ total_savings | money }} on bulk purchase!
                            {%- else -%}
                              ×—×¡×›×ª {{ total_savings | money }} ×‘×¨×›×™×©×” ××¨×•×‘×”!
                            {%- endif -%}
                        </div>
                        {%- endif -%}
                      {%- endif -%}
                    </div>
                    
                    <!-- Quantity Section -->
                    <div class="airsyncx-quantity-section">
                      <div class="airsyncx-quantity-selector">
                        <button type="button" class="airsyncx-quantity-button" data-action="decrease" aria-label="{{ 'products.product.quantity.decrease' | t }}">-</button>
                        <input
                          class="airsyncx-quantity-input"
                          data-quantity-variant-id="{{ main_product.variant.id }}"
                          type="number"
                          name="updates[]"
                          value="{{ main_product.quantity }}"
                          min="{{ main_product.variant.quantity_rule.min | default: 1 }}"
                          {% if main_product.variant.quantity_rule.max != null %}
                            max="{{ main_product.variant.quantity_rule.max }}"
                          {% endif %}
                          {% if main_product.variant.quantity_rule.increment != null %}
                            step="{{ main_product.variant.quantity_rule.increment }}"
                          {% endif %}
                          aria-label="{{ 'products.product.quantity.input_label' | t: product: main_product.product.title | escape }}"
                          id="Quantity-{{ main_product.index | plus: 1 }}"
                          data-index="{{ main_product.index | plus: 1 }}"
                          data-line="{{ main_product.index | plus: 1 }}"
                        >
                        <button type="button" class="airsyncx-quantity-button" data-action="increase" aria-label="{{ 'products.product.quantity.increase' | t }}">+</button>
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- Social Proof Container -->
                <div class="social-proof-container" id="social-proof-container">
                  <div class="social-proof-item active" data-type="recent-purchase">
                    <div class="social-proof-icon">
                      <i class="fas fa-user-check"></i>
                    </div>
                    <div class="social-proof-content">
                      <span class="social-proof-text">
                        {%- if current_language == 'en' -%}
                          <span class="customer-count">12</span> customers purchased this in the last 24 hours
                        {%- else -%}
                          <span class="customer-count">12</span> ×œ×§×•×—×•×ª ×¨×›×©×• ××ª ×–×” ×‘-24 ×”×©×¢×•×ª ×”××—×¨×•× ×•×ª
                        {%- endif -%}
                      </span>
                    </div>
                  </div>
                  
                  <div class="social-proof-item" data-type="limited-stock">
                    <div class="social-proof-icon">
                      <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="social-proof-content">
                      <span class="social-proof-text">
                        {%- if current_language == 'en' -%}
                          Only <span class="stock-count">7</span> units left in stock!
                        {%- else -%}
                          × ×•×ª×¨×• ×¨×§ <span class="stock-count">7</span> ×™×—×™×“×•×ª ×‘××œ××™!
                        {%- endif -%}
                      </span>
                    </div>
                  </div>
                  
                  <div class="social-proof-item" data-type="review">
                    <div class="social-proof-icon">
                      <i class="fas fa-star"></i>
                    </div>
                    <div class="social-proof-content">
                      <span class="social-proof-text">
                        {%- if current_language == 'en' -%}
                          "Amazing quality! Fast delivery!" - <span class="reviewer-name">Sarah M.</span>
                        {%- else -%}
                          "××™×›×•×ª ××“×”×™××”! ××©×œ×•×— ××”×™×¨!" - <span class="reviewer-name">×©×¨×” ×.</span>
                        {%- endif -%}
                      </span>
                    </div>
                  </div>
                  
                  <div class="social-proof-item" data-type="fast-shipping">
                    <div class="social-proof-icon">
                      <i class="fas fa-shipping-fast"></i>
                    </div>
                    <div class="social-proof-content">
                      <span class="social-proof-text">
                        {%- if current_language == 'en' -%}
                          Order within <span class="time-left">2 hours</span> for same-day dispatch
                        {%- else -%}
                          ×”×–××Ÿ ×ª×•×š <span class="time-left">2 ×©×¢×•×ª</span> ×œ××©×œ×•×— ×”×™×•×
                        {%- endif -%}
                      </span>
                    </div>
                  </div>
                  
                  <div class="social-proof-item" data-type="trending">
                    <div class="social-proof-icon">
                      <i class="fas fa-fire"></i>
                    </div>
                    <div class="social-proof-content">
                      <span class="social-proof-text">
                        {%- if current_language == 'en' -%}
                          ğŸ”¥ Trending now! <span class="view-count">247</span> people viewing this
                        {%- else -%}
                          ğŸ”¥ ×˜×¨× ×“×™ ×¢×›×©×™×•! <span class="view-count">247</span> ×× ×©×™× ×¦×¤×• ×‘×–×”
                        {%- endif -%}
                      </span>
                    </div>
                  </div>
                  
                  <div class="social-proof-item" data-type="special-offer">
                    <div class="social-proof-icon">
                      <i class="fas fa-gift"></i>
                    </div>
                    <div class="social-proof-content">
                      <span class="social-proof-text">
                        {%- if current_language == 'en' -%}
                          ğŸ Special offer expires in <span class="countdown">23:45</span>
                        {%- else -%}
                          ğŸ ×”××‘×¦×¢ ×”×–×” ×¤×’ ×ª×•×š <span class="countdown">23:45</span>
                        {%- endif -%}
                      </span>
                    </div>
                  </div>
                </div>
                
                <div class="hero-stats">
                  <div class="stat-item">
                    <div class="stat-icon">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="28" height="28" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
                        <circle cx="9" cy="7" r="4"></circle>
                        <path d="M22 21v-2a4 4 0 0 0-3-3.87"></path>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                      </svg>
                    </div>
                    <div class="stat-content">
                      <div class="stat-number">1000+</div>
                      <div class="stat-label">
                        {% if request.locale.iso_code == 'he' %}
                          ×œ×§×•×—×•×ª ××¨×•×¦×™×
                        {% else %}
                          Happy Customers
                        {% endif %}
                      </div>
                    </div>
                  </div>
                  <div class="stat-separator"></div>
                  <div class="stat-item">
                    <div class="stat-icon">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="28" height="28" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                        <path d="M9 12l2 2 4-4"></path>
                      </svg>
                    </div>
                    <div class="stat-content">
                      <div class="stat-number">30</div>
                      <div class="stat-label">
                        {% if request.locale.iso_code == 'he' %}
                          ×™×•× ×”×—×–×¨ ×›×¡×¤×™
                        {% else %}
                          Day Money Back
                        {% endif %}
                      </div>
                    </div>
                  </div>
                  <div class="stat-separator"></div>
                  <div class="stat-item">
                    <div class="stat-icon">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="28" height="28" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <polyline points="12,6 12,12 16,14"></polyline>
                      </svg>
                    </div>
                    <div class="stat-content">
                      <div class="stat-number">10</div>
                      <div class="stat-label">
                        {% if request.locale.iso_code == 'he' %}
                          ×©× ×™×•×ª ×”×ª×§× ×”
                        {% else %}
                          Seconds Install
                        {% endif %}
                      </div>
                    </div>
                  </div>
                </div>
                
                                {%- else -%}
                <div class="airsyncx-empty-cart-container">
                  <div class="airsyncx-empty-cart-decoration">+</div>
                  <div class="airsyncx-empty-cart-decoration">*</div>
                  <div class="airsyncx-empty-cart-decoration">Â°</div>
                  <div class="airsyncx-empty-cart-decoration">â€¢</div>
                  
                  <div class="airsyncx-empty-cart-icon">
                    <i class="fas fa-shopping-cart"></i>
                            </div>
                  
                  <h1 class="airsyncx-empty-cart-title">{{ 'sections.cart.empty_cart.title' | t }}</h1>
                  <p class="airsyncx-empty-cart-subtitle">{{ 'sections.cart.empty_cart.subtitle' | t }}</p>
                  
                  <a href="{{ routes.root_url }}" class="airsyncx-shop-now-button">
                    {{ 'sections.cart.empty_cart.button' | t }} <i class="fas fa-arrow-left"></i>
                  </a>
                </div>
                    {%- endif -%}
                    </div>
          </div>
        </div>
        
        {%- if cart != empty -%}
          <div class="airsyncx-cart-sidebar">
            <div class="airsyncx-totals-card">
              <h2 class="airsyncx-totals-title">{{ 'sections.cart.order_summary' | t }}</h2>
              <div class="airsyncx-totals-row">
                <span>{{ 'sections.cart.product_price' | t }}</span>
                <span>{{ cart.items_subtotal_price | money }}</span>
              </div>
              {% if cart.taxes_included %}
                <div class="airsyncx-totals-row">
                  <span>{{ 'sections.cart.vat_included' | t }}</span>
                  <span>{{ cart.tax_price | money }}</span>
                    </div>
                          {% endif %}
              
              <div class="airsyncx-totals-row total">
                <span>{{ 'sections.cart.total_payment' | t }}</span>
                <span>{{ cart.total_price | money }}</span>
                    </div>
              
              <div class="airsyncx-progress-container" id="shipping-progress-container" data-free-shipping-threshold="{{ free_shipping_threshold }}">
                {% assign progress_percentage = cart.total_price | divided_by: free_shipping_threshold | times: 100.0 | at_most: 100 %}
                <div class="airsyncx-progress-bar" id="shipping-progress-bar" style="width: {{ progress_percentage }}%;"></div>
                <div class="progress-icon-container" id="shipping-icon" style="left: {{ progress_percentage }}%;">
                  <i class="fas fa-truck-fast progress-icon"></i>
                    </div>
              </div>
              
              {% if cart.total_price < free_shipping_threshold %}
                <div class="airsyncx-progress-text" id="shipping-progress-text">
                  {{ 'sections.cart.free_shipping_message' | t: amount: free_shipping_threshold | minus: cart.total_price | money }}
                      </div>
              {% else %}
                <div class="airsyncx-progress-text progress-complete" id="shipping-progress-text">
                  {{ 'sections.cart.free_shipping_achieved' | t }}
                    </div>
                          {% endif %}
              
              <button type="submit" name="checkout" class="airsyncx-checkout-button">
                {{ 'sections.cart.secure_checkout' | t }}
                        </button>
<div class="airsyncx-payment-icons">
                <img src="https://cdn.shopify.com/s/files/1/0931/3724/0362/files/visa.svg?v=1752672742" alt="Visa" width="40" height="25">
                <img src="https://cdn.shopify.com/s/files/1/0931/3724/0362/files/mastercard.svg?v=1752672742" alt="Mastercard" width="40" height="25">
                <img src="https://cdn.shopify.com/s/files/1/0931/3724/0362/files/paypal.svg?v=1752672742" alt="PayPal" width="40" height="25">
                <img src="https://cdn.shopify.com/s/files/1/0931/3724/0362/files/apple-pay.svg?v=1752672742" alt="Apple Pay" width="40" height="25">
                <img src="https://cdn.shopify.com/s/files/1/0931/3724/0362/files/google-pay.svg?v=1752672742" alt="Google Pay" width="40" height="25">
              </div>
              
              {% if additional_checkout_buttons %}
                <div class="additional-checkout-buttons">
                  {{ content_for_additional_checkout_buttons }}
                        </div>
              {% endif %}
                
              <a href="{{ routes.all_products_collection_url }}" class="airsyncx-continue-shopping">
                {{ 'sections.cart.continue_shopping' | t }}
              </a>
              
              {%- if settings.show_cart_note -%}
                <div class="airsyncx-cart-note">
                  <label for="Cart-note">{{ 'sections.cart.note' | t }}</label>
                  <textarea
                    class="airsyncx-cart-note-input"
                    name="note"
                    id="Cart-note"
                    placeholder="{{ 'sections.cart.note' | t }}"
                  >{{ cart.note }}</textarea>
                </div>
              {%- endif -%}
              
              <div class="cart-note">
                {% if cart.taxes_included or shop.shipping_policy.body != blank %}
                  <div>
                    {%- if cart.taxes_included -%}
                      {{ 'sections.cart.taxes_included' | t }}
                    {%- endif -%}
                    {%- if cart.taxes_included and shop.shipping_policy.body != blank -%}
                      {{ 'general.accessibility.comma' | t }}
                    {%- endif -%}
                    {%- if shop.shipping_policy.body != blank -%}
                      {{ 'sections.cart.shipping_policy_html' | t: link: shop.shipping_policy.url }}
                      {%- endif -%}
                    </div>
                {% endif %}
                    </div>
                      </div>
                    </div>

          <!-- ×”×¢×‘×¨×ª ×”×¡×˜×˜×™×¡×˜×™×§×•×ª ×œ×›××Ÿ ×›×“×™ ×©×™×•×¤×™×¢×• ××—×¨×™ ×”×¡×™×™×“×‘×¨ ×‘××•×‘×™×™×œ -->
          <div class="hero-stats hero-stats-mobile">
            <div class="stat-item">
              <div class="stat-icon">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="28" height="28" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
                  <circle cx="9" cy="7" r="4"></circle>
                  <path d="M22 21v-2a4 4 0 0 0-3-3.87"></path>
                  <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                </svg>
              </div>
              <div class="stat-content">
                <div class="stat-number">1000+</div>
                <div class="stat-label">
                  {% if request.locale.iso_code == 'he' %}
                    ×œ×§×•×—×•×ª ××¨×•×¦×™×
                  {% else %}
                    Happy Customers
                  {% endif %}
                </div>
              </div>
            </div>
            <div class="stat-separator"></div>
            <div class="stat-item">
              <div class="stat-icon">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="28" height="28" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                  <path d="M9 12l2 2 4-4"></path>
                </svg>
              </div>
              <div class="stat-content">
                <div class="stat-number">30</div>
                <div class="stat-label">
                  {% if request.locale.iso_code == 'he' %}
                    ×™×•× ×”×—×–×¨ ×›×¡×¤×™
                  {% else %}
                    Day Money Back
                  {% endif %}
                </div>
              </div>
            </div>
            <div class="stat-separator"></div>
            <div class="stat-item">
              <div class="stat-icon">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="28" height="28" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"></circle>
                  <polyline points="12,6 12,12 16,14"></polyline>
                </svg>
              </div>
              <div class="stat-content">
                <div class="stat-number">10</div>
                <div class="stat-label">
                  {% if request.locale.iso_code == 'he' %}
                    ×©× ×™×•×ª ×”×ª×§× ×”
                  {% else %}
                    Seconds Install
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
                      {%- endif -%}
      </div>
      
      {%- if cart != empty -%}
        <div class="airsyncx-totals-box">
          <div class="airsyncx-total-label">
            <span data-total-text>
              {%- if current_language == 'en' -%}
                Total: {{ cart.total_price | money }}
              {%- else -%}
            ×¡×”"×› ×œ×ª×©×œ×•×: {{ cart.total_price | money }}
              {%- endif -%}
            </span>
            <div class="airsyncx-progress-container" id="shipping-progress-container" data-free-shipping-threshold="{{ free_shipping_threshold }}">
              {% assign progress_percentage = cart.total_price | divided_by: free_shipping_threshold | times: 100.0 | at_most: 100 %}
              <div class="airsyncx-progress-bar" id="shipping-progress-bar" style="width: {{ progress_percentage }}%;"></div>
              <div class="progress-icon-container" id="shipping-icon" style="left: {{ progress_percentage }}%;">
                <i class="fas fa-truck-fast progress-icon"></i>
                        </div>
                    </div>
            {% if cart.total_price < free_shipping_threshold %}
              <small>{{ 'sections.cart.free_shipping_message' | t: amount: free_shipping_threshold | minus: cart.total_price | money }}</small>
            {% endif %}
      </div>
          
          <button type="submit" name="checkout" class="airsyncx-checkout-button mobile" 
                  {% if cart == empty %}disabled{% endif %}
                  aria-describedby="cart-errors">
            {{ 'sections.cart.secure_checkout' | t }}
          </button>
    </div>
      {%- endif -%}

    <p class="visually-hidden" id="cart-live-region-text" aria-live="polite" role="status"></p>
    <p class="visually-hidden" id="shopping-cart-line-item-status" aria-live="polite" aria-hidden="true" role="status">
      {{ 'accessibility.loading' | t }}
    </p>
    
    <div id="cart-errors" class="cart__errors" role="alert" aria-live="assertive"></div>
  </form>
  </div>
</div>

<!-- ×× ×™××¦×™×™×ª ×—×’×™×’×ª ××©×œ×•×— ×—×™× × -->
<div class="free-shipping-celebration" id="free-shipping-celebration">
  <div class="celebration-message">{{ 'sections.cart.free_shipping_celebrate' | t }}</div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // ×‘×“×™×§×ª ×ª××™××•×ª ×“×¤×“×¤×Ÿ ×•×˜×¢×™× ×ª polyfills ×× × ×“×¨×©
    function checkBrowserCompatibility() {
      const isCompatible = {
        fetch: typeof fetch !== 'undefined',
        formData: typeof FormData !== 'undefined',
        localStorageSupported: (function() {
          try {
            const test = 'test';
            localStorage.setItem(test, test);
            localStorage.removeItem(test);
            return true;
          } catch(e) {
            return false;
          }
        })(),
        addEventListener: typeof document.addEventListener !== 'undefined',
        querySelector: typeof document.querySelector !== 'undefined',
        performance: typeof performance !== 'undefined' && typeof performance.mark !== 'undefined'
      };
      
      // Fallback ×œ×“×¤×“×¤× ×™× ×™×©× ×™×
      if (!isCompatible.fetch) {
        console.warn('Fetch API not supported, using XMLHttpRequest');
        window.fetch = function(url, options) {
          return new Promise(function(resolve, reject) {
            const xhr = new XMLHttpRequest();
            xhr.open(options.method || 'GET', url);
            
            Object.keys(options.headers || {}).forEach(function(key) {
              xhr.setRequestHeader(key, options.headers[key]);
            });
            
            xhr.onload = function() {
              resolve({
                ok: xhr.status >= 200 && xhr.status < 300,
                status: xhr.status,
                json: function() {
                  return Promise.resolve(JSON.parse(xhr.responseText));
                }
              });
            };
            
            xhr.onerror = function() {
              reject(new Error('Network error'));
            };
            
            xhr.send(options.body);
          });
        };
      }
      
      // Fallback ×œ-FormData
      if (!isCompatible.formData) {
        console.warn('FormData not supported, using URL encoding');
      }
      
      return isCompatible;
    }
    
    const browserSupport = checkBrowserCompatibility();
    
    // Quantity selectors
    const quantitySelectors = document.querySelectorAll('.airsyncx-quantity-selector');
    const cartForm = document.getElementById('cart');
    
    quantitySelectors.forEach(selector => {
      const decreaseBtn = selector.querySelector('[data-action="decrease"]');
      const increaseBtn = selector.querySelector('[data-action="increase"]');
      const input = selector.querySelector('.airsyncx-quantity-input');
      const lineIndex = input.getAttribute('data-index') || 1;
      const variantId = input.getAttribute('data-quantity-variant-id');
      
      console.log('Line index:', lineIndex, 'Variant ID:', variantId);
      
      decreaseBtn.addEventListener('click', function() {
        const currentValue = parseInt(input.value);
        if (currentValue > 1) {
          input.value = currentValue - 1;
          updateQuantity(lineIndex, currentValue - 1, variantId);
        }
      });
      
      increaseBtn.addEventListener('click', function() {
        const currentValue = parseInt(input.value);
        input.value = currentValue + 1;
        updateQuantity(lineIndex, currentValue + 1, variantId);
      });
      
      input.addEventListener('change', function() {
        const newValue = parseInt(input.value);
        if (newValue > 0) {
          updateQuantity(lineIndex, newValue, variantId);
        } else {
          input.value = 1;
          updateQuantity(lineIndex, 1, variantId);
        }
      });
    });

    function updateQuantity(lineIndex, quantity, variantId) {
      // ×‘×“×™×§×ª ×—×™×‘×•×¨ ×œ××™× ×˜×¨× ×˜
      if (!navigator.onLine) {
        showCartError('××™×Ÿ ×—×™×‘×•×¨ ×œ××™× ×˜×¨× ×˜. ×× × ×‘×“×•×§ ××ª ×”×—×™×‘×•×¨ ×•× ×¡×” ×©×•×‘');
        return;
      }

      // ×”×¦×’×ª ××¦×‘ ×˜×¢×™× ×”
      const productCard = document.querySelector('.airsyncx-product-card');
      const quantityInput = document.querySelector(`[data-quantity-variant-id="${variantId}"]`);
      
      if (productCard) {
        productCard.style.opacity = '0.7';
        productCard.style.transition = 'opacity 0.2s';
        productCard.classList.add('updating');
      }
      
      if (quantityInput) {
        quantityInput.disabled = true;
      }
      
      // ×©×™××•×© ×‘× ×ª×•× ×™ Shopify × ×›×•× ×™× ×œ×¢×“×›×•×Ÿ ×”×¢×’×œ×”
      const formData = new FormData();
      formData.append(`updates[${variantId}]`, quantity);
      formData.append('sections', 'main-cart-items,cart-icon-bubble,cart-live-region-text');
      formData.append('sections_url', window.location.pathname);
      
      // ×‘×§×©×ª AJAX ×œ×¢×“×›×•×Ÿ ×”×¢×’×œ×” ×¢× retry mechanism
      performCartUpdateWithRetry(formData, productCard, quantityInput, variantId);
    }

    function performCartUpdateWithRetry(formData, productCard, quantityInput, variantId, retryCount = 0) {
      // ×¡×™××•×Ÿ ×ª×—×™×œ×ª ××“×™×“×ª ×‘×™×¦×•×¢×™×
      try {
        performance.mark('cart-update-start');
      } catch (e) {
        // Performance API ×œ× × ×ª××š
      }
      
      const maxRetries = 3;
      const timeoutDuration = 10000; // 10 ×©× ×™×•×ª timeout
      
      // ×™×¦×™×¨×ª AbortController ×œ×‘×™×˜×•×œ ×‘×§×©×”
      const abortController = new AbortController();
      const timeoutId = setTimeout(() => {
        abortController.abort();
      }, timeoutDuration);
      
      fetch('/cart/update.js', {
        method: 'POST',
        body: formData,
        headers: {
          'X-Requested-With': 'XMLHttpRequest'
        },
        signal: abortController.signal
      })
      .then(response => {
        clearTimeout(timeoutId);
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
      })
      .then(cart => {
        console.log('Cart updated:', cart);
        
        // ×”×¡×¨×ª ××¦×‘ ×˜×¢×™× ×”
        if (productCard) {
          productCard.style.opacity = '1';
          productCard.classList.remove('updating');
        }
        
        if (quantityInput) {
          quantityInput.disabled = false;
        }
        
        // ××“×™×“×ª ×‘×™×¦×•×¢×™×
        performance.mark('cart-update-end');
        try {
          performance.measure('cart-update-duration', 'cart-update-start', 'cart-update-end');
          const measures = performance.getEntriesByName('cart-update-duration');
          if (measures.length > 0) {
            console.log(`Cart update took ${measures[0].duration.toFixed(2)}ms`);
          }
        } catch (e) {
          // Performance API ×œ× × ×ª××š
        }
        
        // ×¢×“×›×•×Ÿ ××™×“×¢ ×‘×¢××•×“ ×œ××—×¨ ×¢×“×›×•×Ÿ ×”×¢×’×œ×”
        updateCartUI(cart);
        
        // ×¢×“×›×•×Ÿ sections ×©×”×•×—×–×¨×• ××”×©×¨×ª
        if (cart.sections) {
          if (cart.sections['main-cart-items']) {
            const parser = new DOMParser();
            const newDoc = parser.parseFromString(cart.sections['main-cart-items'], 'text/html');
            const newCartItems = newDoc.querySelector('#main-cart-items');
            const currentCartItems = document.querySelector('#main-cart-items');
            if (newCartItems && currentCartItems) {
              currentCartItems.innerHTML = newCartItems.innerHTML;
              // ××ª×—×•×œ ××—×“×© ×©×œ event listeners
              reinitializeQuantitySelectors();
            }
          }
          
          if (cart.sections['cart-icon-bubble']) {
            const cartIconBubble = document.querySelector('#cart-icon-bubble');
            if (cartIconBubble) {
              const parser = new DOMParser();
              const newDoc = parser.parseFromString(cart.sections['cart-icon-bubble'], 'text/html');
              const newBubble = newDoc.querySelector('#cart-icon-bubble');
              if (newBubble) {
                cartIconBubble.innerHTML = newBubble.innerHTML;
              }
            }
          }
        }
      })
      .catch(error => {
        clearTimeout(timeoutId);
        console.error('Error updating cart:', error);
        
        // ×”×¡×¨×ª ××¦×‘ ×˜×¢×™× ×”
        if (productCard) {
          productCard.style.opacity = '1';
          productCard.classList.remove('updating');
        }
        
        if (quantityInput) {
          quantityInput.disabled = false;
        }
        
        // ×˜×™×¤×•×œ ×‘×¡×•×’ ×”×©×’×™××”
        if (error.name === 'AbortError') {
          // Timeout
          if (retryCount < maxRetries) {
            console.log(`Request timed out, retrying... (${retryCount + 1}/${maxRetries})`);
            setTimeout(() => {
              performCartUpdateWithRetry(formData, productCard, quantityInput, variantId, retryCount + 1);
            }, 2000 * (retryCount + 1));
            return;
          } else {
            showCartError(error.message.includes('timeout') ? '×”×‘×§×©×” × ××©×›×ª ×–××Ÿ ×¨×‘ ××“×™. ×× × ×‘×“×•×§ ××ª ×”×—×™×‘×•×¨ ×œ××™× ×˜×¨× ×˜' : error.message);
          }
        } else if (retryCount < maxRetries) {
          // ×©×’×™××•×ª ××—×¨×•×ª - × ×™×¡×™×•×Ÿ × ×•×¡×£
          console.log(`Retrying cart update, attempt ${retryCount + 1}/${maxRetries}`);
          setTimeout(() => {
            performCartUpdateWithRetry(formData, productCard, quantityInput, variantId, retryCount + 1);
          }, 1000 * (retryCount + 1)); // Progressive delay
          return;
        }
        
        // ×˜×™×¤×•×œ ×‘×¡×•×’×™ ×©×’×™××•×ª ×©×•× ×™×
        if (error.message.includes('422')) {
          showCartError('×”×›××•×ª ×©×‘×—×¨×ª ××™× ×” ×–××™× ×” ×‘××œ××™');
        } else if (error.message.includes('network') || error.message.includes('Failed to fetch')) {
          showCartError('×‘×¢×™×™×ª ×—×™×‘×•×¨ ×œ××™× ×˜×¨× ×˜. ×× × ×‘×“×•×§ ××ª ×”×—×™×‘×•×¨ ×•× ×¡×” ×©×•×‘');
        } else {
          showCartError('××™×¨×¢×” ×©×’×™××” ×‘×¢×“×›×•×Ÿ ×”×¢×’×œ×”. ×× × × ×¡×” ×©×•×‘');
        }
        
        // ×‘×—×–×¨×” ×œ××¦×‘ ×”××§×•×¨×™ ×‘××§×¨×” ×©×œ ×©×’×™××”
        const correctInput = document.querySelector(`[data-quantity-variant-id="${variantId}"]`);
        if (correctInput) {
          fetch('/cart.json')
            .then(response => response.json())
            .then(currentCart => {
              const item = currentCart.items.find(item => item.variant_id == variantId);
              if (item && correctInput) {
                correctInput.value = item.quantity;
              }
            })
            .catch(() => {
              // ×× ×’× ×–×” × ×›×©×œ, ×¨×¢× ×•×Ÿ ×”×“×£ ×œ××—×¨ 3 ×©× ×™×•×ª
              showCartError('×©×’×™××” ×§×¨×™×˜×™×ª. ×”×¢××•×“ ×™×ª×¨×¢× ×Ÿ ××•×˜×•××˜×™×ª...');
              setTimeout(() => {
                window.location.reload();
              }, 3000);
            });
        }
      });
    }

    // ×¤×•× ×§×¦×™×” ×œ×”×¦×’×ª ×©×’×™××•×ª ×¢×’×œ×”
    function showCartError(message) {
      const errorContainer = document.getElementById('cart-errors');
      if (errorContainer) {
        const currentLang = document.querySelector('.airsyncx-cart-wrapper').dataset.language || 'he';
        
        // ×ª×¨×’×•× ×”×•×“×¢×•×ª ×©×’×™××” × ×¤×•×¦×•×ª
        const errorTranslations = {
          'network': {
            'he': '×‘×¢×™×™×ª ×—×™×‘×•×¨ ×œ××™× ×˜×¨× ×˜. ×× × ×‘×“×•×§ ××ª ×”×—×™×‘×•×¨ ×•× ×¡×” ×©×•×‘',
            'en': 'Network connection error. Please check your connection and try again'
          },
          'quantity': {
            'he': '×”×›××•×ª ×©×‘×—×¨×ª ××™× ×” ×–××™× ×” ×‘××œ××™',
            'en': 'The selected quantity is not available in stock'
          },
          'general': {
            'he': '××™×¨×¢×” ×©×’×™××” ×‘×¢×“×›×•×Ÿ ×”×¢×’×œ×”. ×× × × ×¡×” ×©×•×‘',
            'en': 'An error occurred updating the cart. Please try again'
          },
          'timeout': {
            'he': '×”×‘×§×©×” × ××©×›×ª ×–××Ÿ ×¨×‘ ××“×™. ×× × ×‘×“×•×§ ××ª ×”×—×™×‘×•×¨ ×œ××™× ×˜×¨× ×˜',
            'en': 'Request is taking too long. Please check your internet connection'
          },
          'critical': {
            'he': '×©×’×™××” ×§×¨×™×˜×™×ª. ×”×¢××•×“ ×™×ª×¨×¢× ×Ÿ ××•×˜×•××˜×™×ª...',
            'en': 'Critical error. The page will refresh automatically...'
          }
        };
        
        // ×‘×“×™×§×” ×× ×™×© ×ª×¨×’×•× ××ª××™×
        let translatedMessage = message;
        for (const [key, translations] of Object.entries(errorTranslations)) {
          if (message.includes(translations.he)) {
            translatedMessage = translations[currentLang] || translations.he;
            break;
          }
        }
        
        errorContainer.textContent = translatedMessage;
        errorContainer.style.display = 'block';
        
        // ×”×¡×ª×¨×ª ×”×©×’×™××” ×œ××—×¨ 5 ×©× ×™×•×ª
        setTimeout(() => {
          errorContainer.style.display = 'none';
        }, 5000);
      }
    }

    // ×¤×•× ×§×¦×™×” ×œ×¢×“×›×•×Ÿ ×××©×§ ×”××©×ª××© ×©×œ ×”×¢×’×œ×”
    function updateCartUI(cart) {
      // ×¢×“×›×•×Ÿ ×¡×›×•× ×›×•×œ×œ
      const totalPriceElements = document.querySelectorAll('.airsyncx-totals-row.total span:last-child');
      totalPriceElements.forEach(el => {
        el.textContent = formatMoney(cart.total_price);
      });
      
      // ×¢×“×›×•×Ÿ ×¡×›×•× ××•×¦×¨×™×
      const subtotalElements = document.querySelectorAll('.airsyncx-totals-row:not(.total) span:last-child');
      subtotalElements.forEach(el => {
        if (el.closest('.airsyncx-totals-row').querySelector('span:first-child').textContent.includes('××—×™×¨ ××•×¦×¨×™×') || 
            el.closest('.airsyncx-totals-row').querySelector('span:first-child').textContent.toLowerCase().includes('product')) {
          // ×ª××™×“ ××¦×™×’ ××ª ×”×¡×›×•× ×”××§×•×¨×™ ×œ×œ× ×”× ×—×•×ª
          el.textContent = formatMoney(cart.items_subtotal_price);
        }
      });
      
      // ×¢×“×›×•×Ÿ ×¡×›×•× ×‘×‘×¨ ×”×ª×—×ª×•×Ÿ ×× ×§×™×™×
      const stickyTotal = document.querySelector('.airsyncx-total-label');
      if (stickyTotal) {
        const totalTextSpan = stickyTotal.querySelector('[data-total-text]');
        const currentLang = document.querySelector('.airsyncx-cart-wrapper').dataset.language || 'he';
        
        if (totalTextSpan) {
          if (currentLang === 'en') {
            totalTextSpan.textContent = `Total: ${formatMoney(cart.total_price)}`;
          } else {
            totalTextSpan.textContent = `×¡×”"×› ×œ×ª×©×œ×•×: ${formatMoney(cart.total_price)}`;
          }
        }
      }
      
      // ×¢×“×›×•×Ÿ ××—×™×¨ ×•×¡×”"×› ×œ××•×¦×¨
      if (cart.items && cart.items.length > 0) {
        const lineItem = cart.items[0]; // ×”××•×¦×¨ ×”×¨××©×•×Ÿ
        
        // ×¢×“×›×•×Ÿ ××—×™×¨ ×¢× ××œ×× ×˜×™× ×¤×¡×™×›×•×œ×•×’×™×™×
        updatePriceDisplay(lineItem);
        
        // ×¢×“×›×•×Ÿ ×”×•×“×¢×ª ×—×™×¡×›×•×Ÿ (airsyncx-savings)
        const savingsElement = document.querySelector('.airsyncx-savings');
        const productQuantity = lineItem.quantity;
        if (savingsElement && lineItem.variant) {
          if (productQuantity > 1 && lineItem.variant.compare_at_price > lineItem.original_price) {
            // ×—×™×©×•×‘ ×”×—×™×¡×›×•×Ÿ ××”××—×™×¨ ×”××§×•×¨×™ ×©×œ Shopify (×œ×œ× ×”× ×—×•×ª ×§×•×¤×•×Ÿ)
            const savings = (lineItem.variant.compare_at_price - lineItem.original_price) * productQuantity;
            const currentLang = document.querySelector('.airsyncx-cart-wrapper').dataset.language || 'he';
            
            if (currentLang === 'en') {
              savingsElement.textContent = `You save ${formatMoney(savings)} on bulk purchase!`;
            } else {
            savingsElement.textContent = `×—×¡×›×ª ${formatMoney(savings)} ×‘×¨×›×™×©×” ××¨×•×‘×”!`;
            }
            savingsElement.style.display = 'inline-block';
          } else {
            // ×× ×”×›××•×ª ×”×™× 1 ××• ××™×Ÿ ×”× ×—×”, ××¡×ª×™×¨×™× ××ª ××œ×× ×˜ ×”×—×™×¡×›×•×Ÿ
            savingsElement.style.display = 'none';
          }
        }
      }
      
      // ×¢×“×›×•×Ÿ ××¡×¤×¨ ×”×¤×¨×™×˜×™× ×‘×¢×’×œ×” (cart-count)
      updateCartItemCount(cart);
      
      // ×¢×“×›×•×Ÿ ×¤×¡ ×”×ª×§×“××•×ª ×“×™× ××™
      updateProgressBar(cart);
      
      // ×¢×“×›×•×Ÿ ×›×¤×ª×•×¨ ×”×ª×©×œ×•×
      updateCheckoutButton(cart);
      
      // ×¢×“×›×•×Ÿ × ×’×™×©×•×ª
      updateAccessibilityLabels(cart);
      
      // ×¢×“×›×•×Ÿ ×©××™×¨×ª ××¦×‘ ×”×¢×’×œ×”
      saveCartState(cart);
      
      // ××ª×—×•×œ ××—×“×© ×©×œ event listeners ×œ×›××•×™×•×ª
      reinitializeQuantitySelectors();
    }
    
    // ×¤×•× ×§×¦×™×” ×œ×¢×“×›×•×Ÿ ××¡×¤×¨ ×”×¤×¨×™×˜×™× ×‘×¢×’×œ×”
    function updateCartItemCount(cart) {
      // ×—×™×©×•×‘ ×¡×”"×› ×¤×¨×™×˜×™× ×‘×¢×’×œ×”
      let totalItems = 0;
      if (cart.items && cart.items.length > 0) {
        totalItems = cart.items.reduce((sum, item) => sum + item.quantity, 0);
      }
      
      // ×¢×“×›×•×Ÿ ×›×œ ×”××œ×× ×˜×™× ×”××¦×™×’×™× ××ª ××¡×¤×¨ ×”×¤×¨×™×˜×™× ×‘×¢×’×œ×”
      const cartCountElements = document.querySelectorAll('.cart-count');
      cartCountElements.forEach(el => {
        el.textContent = totalItems;
        
        // ×‘×“×™×§×” ×× ×™×© ×× ×™××¦×™×” ×œ××•× ×” ×”×¢×’×œ×”
        if (el.classList.contains('cart-count--animate')) {
          el.classList.add('cart-count--updated');
          setTimeout(() => {
            el.classList.remove('cart-count--updated');
          }, 500);
        }
      });
      
      // ×¢×“×›×•×Ÿ ×’× ×œ××œ×× ×˜×™× ×¢× data-cart-count
      const dataCartCountElements = document.querySelectorAll('[data-cart-count]');
      dataCartCountElements.forEach(el => {
        el.setAttribute('data-cart-count', totalItems);
        el.textContent = totalItems;
      });
      
      // ×‘××§×¨×” ×©×œ ××™×™×§×•×Ÿ ×¢×’×œ×” ×‘××ª×¨
      const cartIcons = document.querySelectorAll('.header__icon--cart-items');
      cartIcons.forEach(icon => {
        if (totalItems > 0) {
          icon.setAttribute('data-cart-items', totalItems);
          icon.classList.add('header__icon--cart-items--visible');
        } else {
          icon.removeAttribute('data-cart-items');
          icon.classList.remove('header__icon--cart-items--visible');
        }
      });
    }

    function formatMoney(cents) {
      const currentCurrency = document.querySelector('.airsyncx-cart-wrapper').dataset.currency || 'ILS';
      const value = (cents / 100).toFixed(2);
      
      if (currentCurrency === 'USD') {
        return `$${value}`;
      } else if (currentCurrency === 'ILS') {
        return `â‚ª${value}`;
      } else {
        // ×‘×¨×™×¨×ª ××—×“×œ ×œ×©×§×œ
        return `â‚ª${value}`;
      }
    }
    
    // ×¢×“×›×•×Ÿ ××—×™×¨ ×œ×™×—×™×“×” ×¢× ××œ×× ×˜×™× ×¤×¡×™×›×•×œ×•×’×™×™×
    function updatePriceDisplay(lineItem) {
      const unitPriceElement = document.querySelector('.airsyncx-unit-price');
      if (unitPriceElement && lineItem) {
        const priceSpan = unitPriceElement.querySelector('span');
        if (priceSpan) {
          // × ×™×§×•×™ ×”×ª×•×›×Ÿ ×”×§×™×™×
          priceSpan.innerHTML = '';
          
          // ×”×•×¡×¤×ª ××—×™×¨ ×”×©×•×•××” ×× ×§×™×™×
          if (lineItem.variant && lineItem.variant.compare_at_price > lineItem.original_price) {
            const compareSpan = document.createElement('span');
            compareSpan.style.textDecoration = 'line-through';
            compareSpan.style.opacity = '0.7';
            compareSpan.style.marginRight = '5px';
            compareSpan.style.fontSize = '0.85em';
            compareSpan.style.color = '#ffffff';
            compareSpan.style.whiteSpace = 'nowrap'; // ××•× ×¢ ×©×‘×™×¨×ª ×©×•×¨×”
            compareSpan.style.display = 'inline-block'; // ×ª×¦×•×’×” ×‘×œ×•×§ ×¤× ×™××™
            compareSpan.textContent = formatMoney(lineItem.variant.compare_at_price);
            priceSpan.appendChild(compareSpan);
          }
          
          // ×”×•×¡×¤×ª ×”××—×™×¨ ×”××§×•×¨×™ (×œ× ×”××—×™×¨ ××—×¨×™ ×”× ×—×”)
          const currentLang = document.querySelector('.airsyncx-cart-wrapper').dataset.language || 'he';
          const priceLabel = currentLang === 'en' ? 'Price: ' : '××—×™×¨: ';
          const priceTextSpan = document.createElement('span');
          priceTextSpan.style.whiteSpace = 'nowrap'; // ××•× ×¢ ×©×‘×™×¨×ª ×©×•×¨×”
          priceTextSpan.textContent = priceLabel + formatMoney(lineItem.original_price);
          priceSpan.appendChild(priceTextSpan);
        }
      }
    }

    // ×¢×“×›×•×Ÿ ×¤×¡ ×”×ª×§×“××•×ª ×“×™× ××™
    function updateProgressBar(cart) {
      const progressContainer = document.getElementById('shipping-progress-container');
      const iconContainer = document.getElementById('shipping-icon');
      const progressText = document.getElementById('shipping-progress-text');
      
      if (!progressContainer || !iconContainer || !progressText) return;
      
      const currentCurrency = document.querySelector('.airsyncx-cart-wrapper').dataset.currency || 'ILS';
      let maxAmount = 19900; // Default threshold for ILS (â‚ª199)
      
      // Set appropriate threshold based on currency
      if (currentCurrency === 'USD') {
        maxAmount = 5600; // $56 for USD
      }
      
      const previousPercentage = progressContainer.dataset.previousPercentage || 0;
      const progressPercentage = Math.min((cart.total_price / maxAmount) * 100, 100);
      
      // ×¢×“×›×•×Ÿ ×”×¨×§×¢ ×©×œ ×”××™×›×œ (××™×œ×•×™ ×”×“×¨×’×ª×™ ×©×œ ×”×¦×‘×¢)
      progressContainer.style.setProperty('--progress-percentage', `${progressPercentage}%`);
      
      // ×¢×“×›×•×Ÿ ××™×§×•× ×”××™×™×§×•×Ÿ
      iconContainer.style.left = `${progressPercentage}%`;
      
      // ×¢×“×›×•×Ÿ ×˜×§×¡×˜
      if (cart.total_price < maxAmount) {
        const amountLeft = maxAmount - cart.total_price;
        const currentLang = document.querySelector('.airsyncx-cart-wrapper').dataset.language || 'he';
        if (currentLang === 'en') {
          progressText.textContent = `Just ${formatMoney(amountLeft)} more and you'll unlock free shipping! ğŸššğŸ’°`;
        } else {
          progressText.textContent = `×¢×•×“ ${formatMoney(amountLeft)} ×‘×œ×‘×“ ×•×—×¡×›×ª ××ª ×“××™ ×”××©×œ×•×—! ğŸššğŸ’°`;
        }
        progressText.classList.remove('progress-complete');
        progressContainer.classList.remove('progress-complete');
      } else {
        const currentLang = document.querySelector('.airsyncx-cart-wrapper').dataset.language || 'he';
        if (currentLang === 'en') {
          progressText.textContent = `You've unlocked free shipping! ğŸ‰`;
        } else {
          progressText.textContent = '×”×’×¢×ª ×œ××©×œ×•×— ×—×™× ×! ğŸ‰';
        }
        progressText.classList.add('progress-complete');
        progressContainer.classList.add('progress-complete');
      }
      
      // ×¢×“×›×•×Ÿ ×›×œ ××™×›×œ×™ ×”×”×ª×§×“××•×ª ×‘×¢××•×“ (×œ××§×¨×” ×©×™×© ×™×•×ª×¨ ×××—×“)
      const allProgressContainers = document.querySelectorAll('.airsyncx-progress-container');
      allProgressContainers.forEach(container => {
        if (container !== progressContainer) {
          container.style.setProperty('--progress-percentage', `${progressPercentage}%`);
          if (progressPercentage >= 100) {
            container.classList.add('progress-complete');
          } else {
            container.classList.remove('progress-complete');
          }
        }
      });
      
      // ×¢×“×›×•×Ÿ ×©××™×¨×ª ×”×¢×¨×š ×”×§×•×“× ×©×œ ×”××—×•×–×™× ×œ×”×©×•×•××”
      progressContainer.dataset.previousPercentage = progressPercentage;
      
      // ×¢×“×›×•×Ÿ ×‘×“×™×§×” ×× ×”×’×¢× ×• ×œ×¡×£ ×©×œ ××©×œ×•×— ×—×™× × ×•×–×” ×©×™× ×•×™ ×××¦×‘ ×§×•×“×
      if (progressPercentage >= 100 && previousPercentage < 100) {
        showFreeShippingCelebration();
      }
    }
    
    // ×¢×“×›×•×Ÿ ×¨××©×•× ×™ ×©×œ ×”×¤×¡ ×‘×˜×¢×™× ×ª ×”×¢××•×“
    fetch('/cart.json')
      .then(response => response.json())
      .then(cart => {
        updateProgressBar(cart);
      })
      .catch(error => {
        console.error('Error fetching cart:', error);
      });
    // ×¤×•× ×§×¦×™×” ×œ×”×¦×’×ª ×× ×™××¦×™×™×ª ×—×’×™×’×ª ××©×œ×•×— ×—×™× ×
    function showFreeShippingCelebration() {
      const celebrationContainer = document.getElementById('free-shipping-celebration');
      if (!celebrationContainer) return;
      
      // ××—×™×§×ª ××™××•×’'×™× ×§×•×“××™× ×× ×§×™×™××™×
      const existingEmojis = celebrationContainer.querySelectorAll('.money-emoji');
      existingEmojis.forEach(emoji => emoji.remove());
      
      // ×”×¦×’×ª ×§×•× ×˜×™×™× ×¨ ×”×× ×™××¦×™×”
      celebrationContainer.style.display = 'block';
      
      // ××™××•×’'×™× ×©×œ ×›×¡×£
      const moneyEmojis = ['ğŸ’°', 'ğŸ’µ', 'ğŸ’', 'ğŸ¤‘', 'ğŸ’¸', 'ğŸ’²', 'ğŸ†', 'âœ¨'];
      
      // ×™×¦×™×¨×ª ××™××•×’'×™× ××ª×¢×•×¤×¤×™×
      for (let i = 0; i < 40; i++) {
        const emoji = document.createElement('div');
        emoji.className = 'money-emoji';
        emoji.textContent = moneyEmojis[Math.floor(Math.random() * moneyEmojis.length)];
        
        // ××™×§×•× ××§×¨××™
        const randomLeft = Math.random() * 100;
        emoji.style.left = `${randomLeft}%`;
        
        // ×’×•×“×œ ××§×¨××™
        const randomSize = Math.random() * 24 + 16;
        emoji.style.fontSize = `${randomSize}px`;
        
        // ×”×©×”×™×™×” ××§×¨××™×ª
        const randomDelay = Math.random() * 1;
        emoji.style.animationDelay = `${randomDelay}s`;
        
        // ××©×š ××§×¨××™
        const randomDuration = Math.random() * 1.5 + 2;
        emoji.style.animationDuration = `${randomDuration}s`;
        
        celebrationContainer.appendChild(emoji);
      }
      
      // ×¡×’×™×¨×ª ×”×× ×™××¦×™×” ××•×˜×•××˜×™×ª ×œ××—×¨ 4 ×©× ×™×•×ª
      setTimeout(() => {
        celebrationContainer.style.display = 'none';
      }, 4000);
    }

    // ×× ×’× ×•×Ÿ ×§×•×¤×•× ×™× AJAX - ×”×•×¡×¨
    
    // ×¤×•× ×§×¦×™×” ×œ×¢×“×›×•×Ÿ ×›×¤×ª×•×¨ ×”×ª×©×œ×•×
    function updateCheckoutButton(cart) {
      const checkoutButtons = document.querySelectorAll('.airsyncx-checkout-button');
      const currentLang = document.querySelector('.airsyncx-cart-wrapper').dataset.language || 'he';
      
      checkoutButtons.forEach(button => {
        if (cart.item_count === 0) {
          button.disabled = true;
          button.textContent = currentLang === 'en' ? 'Cart is empty' : '×”×¢×’×œ×” ×¨×™×§×”';
        } else {
          button.disabled = false;
          button.textContent = button.textContent; // Keep the existing translated text
        }
      });
    }

    // ××ª×—×•×œ ××—×“×© ×©×œ quantity selectors ×œ××—×¨ ×¢×“×›×•×Ÿ AJAX
    function reinitializeQuantitySelectors() {
      // ×”×¡×¨×ª event listeners ×§×™×™××™×
      const existingSelectors = document.querySelectorAll('.airsyncx-quantity-selector');
      existingSelectors.forEach(selector => {
        const newSelector = selector.cloneNode(true);
        selector.parentNode.replaceChild(newSelector, selector);
      });
      
      // ×”×•×¡×¤×ª event listeners ××—×“×©
      const quantitySelectors = document.querySelectorAll('.airsyncx-quantity-selector');
      quantitySelectors.forEach(selector => {
        const decreaseBtn = selector.querySelector('[data-action="decrease"]');
        const increaseBtn = selector.querySelector('[data-action="increase"]');
        const input = selector.querySelector('.airsyncx-quantity-input');
        
        if (!input) return;
        
        const lineIndex = input.getAttribute('data-index') || 1;
        const variantId = input.getAttribute('data-quantity-variant-id');
        
        decreaseBtn.addEventListener('click', function() {
          const currentValue = parseInt(input.value);
          const minValue = parseInt(input.getAttribute('min')) || 1;
          if (currentValue > minValue) {
            input.value = currentValue - 1;
            debouncedUpdateQuantity(lineIndex, currentValue - 1, variantId);
          }
        });
        
        increaseBtn.addEventListener('click', function() {
          const currentValue = parseInt(input.value);
          const maxQuantity = input.getAttribute('max') || 99;
          if (currentValue < maxQuantity) {
            input.value = currentValue + 1;
            debouncedUpdateQuantity(lineIndex, currentValue + 1, variantId);
          }
        });
        
        input.addEventListener('change', function() {
          const newValue = parseInt(input.value);
          const minQuantity = parseInt(input.getAttribute('min')) || 1;
          const maxQuantity = parseInt(input.getAttribute('max')) || 99;
          
          if (newValue < minQuantity) {
            input.value = minQuantity;
            debouncedUpdateQuantity(lineIndex, minQuantity, variantId);
          } else if (newValue > maxQuantity) {
            input.value = maxQuantity;
            debouncedUpdateQuantity(lineIndex, maxQuantity, variantId);
          } else if (newValue > 0) {
            debouncedUpdateQuantity(lineIndex, newValue, variantId);
          } else {
            input.value = minQuantity;
            debouncedUpdateQuantity(lineIndex, minQuantity, variantId);
          }
        });
      });
    }

    // Debouncing ×œ×¢×“×›×•× ×™ ×›××•×ª - ××•× ×¢ ×‘×§×©×•×ª ××¨×•×‘×•×ª
    const debouncedUpdateQuantity = debounce(updateQuantity, 500);

    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    // × ×™×•×•×˜ ××§×œ×“×ª ×•× ×’×™×©×•×ª
    document.addEventListener('keydown', function(e) {
      // ESC ×œ×¡×’×™×¨×ª ×”×•×“×¢×•×ª ×©×’×™××”
      if (e.key === 'Escape') {
        const errorContainer = document.getElementById('cart-errors');
        if (errorContainer && errorContainer.style.display !== 'none') {
          errorContainer.style.display = 'none';
        }
      }
      
      // Enter ×¢×œ ×›×¤×ª×•×¨×™ ×›××•×ª
      if (e.key === 'Enter' && e.target.classList.contains('airsyncx-quantity-button')) {
        e.target.click();
      }
      
      // ×—×™×¦×™ ××§×œ×“×ª ×œ×©×™× ×•×™ ×›××•×ª
      if (e.target.classList.contains('airsyncx-quantity-input')) {
        if (e.key === 'ArrowUp') {
          e.preventDefault();
          const increaseBtn = e.target.parentNode.querySelector('[data-action="increase"]');
          if (increaseBtn) increaseBtn.click();
        } else if (e.key === 'ArrowDown') {
          e.preventDefault();
          const decreaseBtn = e.target.parentNode.querySelector('[data-action="decrease"]');
          if (decreaseBtn) decreaseBtn.click();
        }
      }
    });

    // ×”×•×¡×¤×ª ARIA labels ×•×¢×¨×›×™× ×“×™× ××™×™×
    function updateAccessibilityLabels(cart) {
      const currentLang = document.querySelector('.airsyncx-cart-wrapper').dataset.language || 'he';
      
      // ×¢×“×›×•×Ÿ ×ª×™××•×¨ ××•× ×” ×¢×’×œ×”
      const cartCountElements = document.querySelectorAll('[aria-label*="cart"], [aria-label*="×¢×’×œ×”"]');
      cartCountElements.forEach(el => {
        const itemCount = cart.item_count || 0;
        if (currentLang === 'en') {
          el.setAttribute('aria-label', `Shopping cart with ${itemCount} items`);
        } else {
          el.setAttribute('aria-label', `×¢×’×œ×ª ×§× ×™×•×ª ×¢× ${itemCount} ×¤×¨×™×˜×™×`);
        }
      });
      
      // ×¢×“×›×•×Ÿ live region
      const liveRegion = document.getElementById('cart-live-region-text');
      if (liveRegion && cart.item_count !== undefined) {
        if (currentLang === 'en') {
          liveRegion.textContent = `Cart contains ${cart.item_count} items. Total ${formatMoney(cart.total_price)}`;
        } else {
          liveRegion.textContent = `×”×¢×’×œ×” ××›×™×œ×” ${cart.item_count} ×¤×¨×™×˜×™×. ×¡×”"×› ${formatMoney(cart.total_price)}`;
        }
      }
    }

    // ×¤×•× ×§×¦×™×” ×œ×‘×“×™×§×ª ××œ××™
    function validateInventory(item) {
      // ×‘×“×™×§×” ×× ×”××•×¦×¨ ×× ×•×”×œ ×¢×œ ×™×“×™ Shopify
      if (item.variant && item.variant.inventory_management === 'shopify') {
        // ×‘×“×™×§×” ×× ×”××“×™× ×™×•×ª ×”×™× ×œ×× ×•×¢ ×¨×›×™×©×” ×›×©××™×Ÿ ××œ××™
        if (item.variant.inventory_policy === 'deny' && item.variant.inventory_quantity !== undefined) {
          if (item.variant.inventory_quantity < item.quantity) {
            const currentLang = document.querySelector('.airsyncx-cart-wrapper').dataset.language || 'he';
            const errorMsg = currentLang === 'en' 
              ? `Only ${item.variant.inventory_quantity} units available for ${item.product_title}`
              : `×¨×§ ${item.variant.inventory_quantity} ×™×—×™×“×•×ª ×–××™× ×•×ª ×¢×‘×•×¨ ${item.product_title}`;
            showCartError(errorMsg);
            
            // ×¢×“×›×•×Ÿ ××•×˜×•××˜×™ ×œ×›××•×ª ×–××™× ×”
            const input = document.querySelector(`[data-quantity-variant-id="${item.variant_id}"]`);
            if (input && item.variant.inventory_quantity > 0) {
              input.value = item.variant.inventory_quantity;
              updateQuantity(input.getAttribute('data-index'), item.variant.inventory_quantity, item.variant_id);
            }
          }
          
          // ××–×”×¨×ª ××œ××™ × ××•×š
          if (item.variant.inventory_quantity > 0 && item.variant.inventory_quantity <= 10) {
            const stockWarning = document.querySelector('.airsyncx-stock-warning');
            if (stockWarning) {
              const currentLang = document.querySelector('.airsyncx-cart-wrapper').dataset.language || 'he';
              stockWarning.textContent = currentLang === 'en' 
                ? `Only ${item.variant.inventory_quantity} left in stock!`
                : `× ×•×ª×¨×• ×¨×§ ${item.variant.inventory_quantity} ×™×—×™×“×•×ª ×‘××œ××™!`;
              stockWarning.style.display = 'block';
            }
          }
        }
      }
    }

    // ×©××™×¨×ª ××¦×‘ ×”×¢×’×œ×” ×‘-localStorage ×œ×©×—×–×•×¨ ×‘××§×¨×” ×©×œ ×‘×¢×™×”
    function saveCartState(cart) {
      try {
        const cartState = {
          timestamp: Date.now(),
          items: cart.items,
          total_price: cart.total_price,
          item_count: cart.item_count,
          currency: document.querySelector('.airsyncx-cart-wrapper').dataset.currency
        };
        localStorage.setItem('airsyncx_cart_backup', JSON.stringify(cartState));
      } catch (e) {
        console.warn('Could not save cart state to localStorage');
      }
    }

    // ×˜×¢×™× ×ª ××¦×‘ ×”×¢×’×œ×” ×-localStorage
    function loadCartState() {
      try {
        const saved = localStorage.getItem('airsyncx_cart_backup');
        if (saved) {
          const cartState = JSON.parse(saved);
          // ×‘×“×™×§×” ×©×”××™×“×¢ ×œ× ×™×©×Ÿ ××“×™ (×™×•×ª×¨ ×-24 ×©×¢×•×ª)
          if (Date.now() - cartState.timestamp < 24 * 60 * 60 * 1000) {
            return cartState;
          } else {
            localStorage.removeItem('airsyncx_cart_backup');
          }
        }
      } catch (e) {
        console.warn('Could not load cart state from localStorage');
        localStorage.removeItem('airsyncx_cart_backup');
      }
      return null;
    }

    // ××™×¨×•×¢×™ offline/online
    window.addEventListener('online', function() {
      const currentLang = document.querySelector('.airsyncx-cart-wrapper').dataset.language || 'he';
      const onlineMsg = currentLang === 'en' ? 'Internet connection restored' : '×”×—×™×‘×•×¨ ×œ××™× ×˜×¨× ×˜ ×—×–×¨';
      showSuccessMessage(onlineMsg);
      
      // ×‘×“×™×§×” ×× ×™×© ×©×™× ×•×™×™× ×©×œ× × ×©××¨×•
      const savedState = loadCartState();
      if (savedState) {
        fetch('/cart.json')
          .then(response => response.json())
          .then(currentCart => {
            // ×”×©×•×•××ª ××¦×‘ ×©××•×¨ ×œ××¦×‘ × ×•×›×—×™
            if (savedState.item_count !== currentCart.item_count) {
              const syncMsg = currentLang === 'en' 
                ? 'Unsaved changes detected. The page will refresh to sync the cart'
                : '×–×•×”×• ×©×™× ×•×™×™× ×©×œ× × ×©××¨×•. ×”×¢××•×“ ×™×ª×¨×¢× ×Ÿ ×›×“×™ ×œ×¡× ×›×¨×Ÿ ××ª ×”×¢×’×œ×”';
              showCartError(syncMsg);
              setTimeout(() => window.location.reload(), 3000);
            }
          });
      }
    });

    window.addEventListener('offline', function() {
      const currentLang = document.querySelector('.airsyncx-cart-wrapper').dataset.language || 'he';
      const offlineMsg = currentLang === 'en' 
        ? 'No internet connection. Changes will be saved locally until connection returns'
        : '××™×Ÿ ×—×™×‘×•×¨ ×œ××™× ×˜×¨× ×˜. ×”×©×™× ×•×™×™× ×™×™×©××¨×• ××§×•××™×ª ×¢×“ ×©×”×—×™×‘×•×¨ ×™×—×–×•×¨';
      showCartError(offlineMsg);
    });

    // ×¤×•× ×§×¦×™×” ×œ×”×¦×’×ª ×”×•×“×¢×ª ×”×¦×œ×—×”
    function showSuccessMessage(message) {
      const currentLang = document.querySelector('.airsyncx-cart-wrapper').dataset.language || 'he';
      
      // ×ª×¨×’×•× ×”×•×“×¢×•×ª ×”×¦×œ×—×”
      const successTranslations = {
        'updated': {
          'he': '×”×›××•×ª ×¢×•×“×›× ×” ×‘×”×¦×œ×—×”',
          'en': 'Quantity updated successfully'
        },
        'removed': {
          'he': '×¤×¨×™×˜ ×œ× ×ª×§×™×Ÿ ×”×•×¡×¨ ××”×¢×’×œ×”',
          'en': 'Invalid item removed from cart'
        },
        'online': {
          'he': '×”×—×™×‘×•×¨ ×œ××™× ×˜×¨× ×˜ ×—×–×¨',
          'en': 'Internet connection restored'
        }
      };
      
      // ×‘×“×™×§×” ×× ×™×© ×ª×¨×’×•× ××ª××™×
      let translatedMessage = message;
      for (const [key, translations] of Object.entries(successTranslations)) {
        if (message.includes(translations.he)) {
          translatedMessage = translations[currentLang] || translations.he;
          break;
        }
      }
      
      const successDiv = document.createElement('div');
      successDiv.className = 'cart-success-message';
      successDiv.textContent = translatedMessage;
      document.body.appendChild(successDiv);
      
      setTimeout(() => {
        successDiv.classList.add('show');
      }, 100);
      
      setTimeout(() => {
        successDiv.classList.remove('show');
        setTimeout(() => {
          successDiv.remove();
        }, 300);
      }, 2000);
    }

    // ×‘×“×™×§×ª ×ª×•×§×£ ×¤×¨×™×˜×™ ×”×¢×’×œ×”
    function validateCartItems() {
      fetch('/cart.json')
        .then(response => response.json())
        .then(cart => {
          if (cart.items && cart.items.length > 0) {
            cart.items.forEach(item => {
              // ×‘×“×™×§×” ×©×”××•×¦×¨ ×¢×“×™×™×Ÿ ×§×™×™× ×•×¤×¢×™×œ
              if (!item.product_id || !item.variant_id) {
                const currentLang = document.querySelector('.airsyncx-cart-wrapper').dataset.language || 'he';
                const errorMsg = currentLang === 'en' 
                  ? `Product "${item.title || 'Unknown'}" is no longer available`
                  : `×”××•×¦×¨ "${item.title || '×œ× ×™×“×•×¢'}" ××™× ×• ×–××™×Ÿ ×™×•×ª×¨`;
                showCartError(errorMsg);
                // ×”×¡×¨×” ××•×˜×•××˜×™×ª ×©×œ ×”××•×¦×¨ ×”×œ× ×ª×§×™×Ÿ
                removeInvalidItem(item.key);
              }
              
              // ×‘×“×™×§×ª ××œ××™ ××¢×•×“×›× ×ª
              validateInventory(item);
            });
          }
        })
        .catch(error => {
          console.error('Error validating cart items:', error);
        });
    }

    // ×”×¡×¨×ª ×¤×¨×™×˜ ×œ× ×ª×§×™×Ÿ ××”×¢×’×œ×”
    function removeInvalidItem(itemKey) {
      const formData = new FormData();
      formData.append(`updates[${itemKey}]`, 0);
      
      fetch('/cart/update.js', {
        method: 'POST',
        body: formData
      })
      .then(response => response.json())
      .then(cart => {
        updateCartUI(cart);
        const currentLang = document.querySelector('.airsyncx-cart-wrapper').dataset.language || 'he';
        const successMsg = currentLang === 'en' 
          ? 'Invalid item removed from cart'
          : '×¤×¨×™×˜ ×œ× ×ª×§×™×Ÿ ×”×•×¡×¨ ××”×¢×’×œ×”';
        showSuccessMessage(successMsg);
      })
      .catch(error => {
        console.error('Error removing invalid item:', error);
      });
    }

    // ×‘×™×¦×•×¢ ×‘×“×™×§×ª ×ª×•×§×£ ×‘×˜×¢×™× ×ª ×”×“×£
    validateCartItems();

    // ×‘×“×™×§×” ××—×–×•×¨×™×ª ×›×œ 30 ×©× ×™×•×ª ×× ×”×“×£ ×¤×¢×™×œ
    let validationInterval;
    
    function startPeriodicValidation() {
      validationInterval = setInterval(() => {
        if (document.visibilityState === 'visible') {
          validateCartItems();
        }
      }, 30000); // ×›×œ 30 ×©× ×™×•×ª
    }

    function stopPeriodicValidation() {
      if (validationInterval) {
        clearInterval(validationInterval);
      }
    }

    // ×”×¤×¢×œ×”/×”×¤×¡×§×” ×©×œ ×‘×“×™×§×•×ª ××—×–×•×¨×™×•×ª ×¢×œ ×¤×™ × ×¨××•×ª ×”×“×£
    document.addEventListener('visibilitychange', function() {
      if (document.visibilityState === 'visible') {
        validateCartItems();
        startPeriodicValidation();
      } else {
        stopPeriodicValidation();
      }
    });

    // ×”×¤×¢×œ×ª ×‘×“×™×§×•×ª ××—×–×•×¨×™×•×ª
    startPeriodicValidation();

    // Shopify Markets - Currency & Language Switching
    const currencySelector = document.getElementById('CartCurrencySelector');
    const languageSelector = document.getElementById('CartLanguageSelector');
    const localizationForm = document.getElementById('CartLocalizationForm');
    
    function handleLocalizationChange() {
      if (localizationForm) {
        // ×”×¦×’×ª loading state
        document.body.classList.add('localization-loading');
        
        // ×©×œ×™×—×ª ×”×˜×•×¤×¡
        localizationForm.submit();
      }
    }
    
    // ×˜×™×¤×•×œ ××™×•×—×“ ×‘×‘×—×™×¨×ª ××˜×‘×¢
    function handleCurrencyChange() {
      const selectedCountry = currencySelector.value;
      
      // ×¢×“×›×•×Ÿ URL ×¢× ×”××˜×‘×¢ ×”×—×“×©
      const currentUrl = new URL(window.location.href);
      
      if (selectedCountry === 'IL') {
        currentUrl.searchParams.set('currency', 'ILS');
        currentUrl.searchParams.set('country', 'IL');
      } else if (selectedCountry === 'US') {
        currentUrl.searchParams.set('currency', 'USD');
        currentUrl.searchParams.set('country', 'US');
      }
      
      // ×”×¦×’×ª loading state
      document.body.classList.add('localization-loading');
      
      // × ×™×•×•×˜ ×œ×›×ª×•×‘×ª ×”×—×“×©×”
      window.location.href = currentUrl.toString();
    }
    
    if (currencySelector) {
      currencySelector.addEventListener('change', handleCurrencyChange);
    }
    
    if (languageSelector) {
      languageSelector.addEventListener('change', handleLocalizationChange);
    }

    // Dynamic text updates based on language
    function updateDynamicTexts() {
      const currentLang = document.querySelector('.airsyncx-cart-wrapper').dataset.language;
      const currentCurrency = document.querySelector('.airsyncx-cart-wrapper').dataset.currency;
      
      // ×¢×“×›×•×Ÿ ×˜×§×¡×˜×™× ×“×™× ××™×™× ×¢×œ ×¤×™ ×©×¤×”
      if (currentLang === 'en') {
        // Update trust badges for English
        const trustBadges = {
          secure: 'Secure Purchase',
          warranty: '1 Year Warranty',
          returns: '30 Days Returns'
        };
        
        document.querySelectorAll('.airsyncx-trust-badge').forEach(badge => {
          const icon = badge.querySelector('i');
          if (icon) {
            const textNode = badge.childNodes[badge.childNodes.length - 1];
            if (icon.classList.contains('fa-shield-alt') && textNode) {
              textNode.nodeValue = ' ' + trustBadges.secure;
            } else if (icon.classList.contains('fa-medal') && textNode) {
              textNode.nodeValue = ' ' + trustBadges.warranty;
            } else if (icon.classList.contains('fa-exchange-alt') && textNode) {
              textNode.nodeValue = ' ' + trustBadges.returns;
            }
          }
        });
      }
      
      // ×¢×“×›×•×Ÿ ×›×™×•×•×Ÿ ×”×˜×§×¡×˜
      const isRTL = currentLang === 'he' || currentLang === 'ar';
      document.querySelectorAll('.airsyncx-cart-wrapper').forEach(wrapper => {
        wrapper.setAttribute('dir', isRTL ? 'rtl' : 'ltr');
      });
      
      // ×¢×“×›×•×Ÿ ×™×™×©×•×¨ ×˜×§×¡×˜ ×‘×”×ª××
      document.querySelectorAll('.airsyncx-product-name, .airsyncx-product-variant, .airsyncx-unit-price').forEach(el => {
        el.style.textAlign = isRTL ? 'right' : 'left';
      });
    }

    // ×§×¨×™××” ×¨××©×•× ×™×ª ×œ×¢×“×›×•×Ÿ ×˜×§×¡×˜×™×
    updateDynamicTexts();
    
    // ××ª×—×•×œ ××˜×‘×¢ × ×›×•×Ÿ ×‘×˜×¢×™× ×ª ×”×“×£
    function initializeCurrency() {
      const currentCurrency = document.querySelector('.airsyncx-cart-wrapper').dataset.currency;
      const currencySelector = document.getElementById('CartCurrencySelector');
      
      if (currencySelector && currentCurrency) {
        if (currentCurrency === 'USD') {
          currencySelector.value = 'US';
        } else {
          currencySelector.value = 'IL';
        }
      }
    }
    
    // ×§×¨×™××” ×œ××ª×—×•×œ ×”××˜×‘×¢
    initializeCurrency();

    // Listen for currency format updates
    document.addEventListener('cart:updated', function() {
      updateDynamicTexts();
    });
  });
</script>

{% schema %}
{
  "name": "t:sections.main-cart-items.name",
  "settings": [
    {
      "type": "header",
      "content": "t:sections.all.padding.section_padding_heading"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "t:sections.all.padding.padding_top",
      "default": 36
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "t:sections.all.padding.padding_bottom",
      "default": 36
    },
    {
      "type": "image_picker",
      "id": "background_image",
      "label": "×ª××•× ×ª ×¨×§×¢ ×œ×¢×’×œ×”"
    }
  ]
}
{% endschema %}
